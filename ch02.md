# 第二章 创建第一个无服务API

本章包括

- 用Claudia创建并部署一个API
- Claudia是如何在AWS上面部署API的
- API网关是如何工作的

本章的主要目标是使用Claudia构建你的第一个无服务器API，并将其部署到AWS Lambda和API Gateway上。 你还将看到传统应用程序和无服务器应用程序结构之间的差异，并在了解Claudia在幕后所做的工作的同时能够更好地掌握Claudia。 要从本章中获得最大收益，你应该了解第1章中描述的无服务器的基本概念。

## 2.1 组装披萨原料：构建API

玛丽亚姨妈很高兴和感激你帮助她重新开始她的买卖。 她甚至为你做著名的意大利辣香肠披萨！ （此刻尽量不要饿！）

玛丽亚姨妈已经拥有一个网站，因此你将为她构建一个后端应用程序——更确切地说，是一个API——使她的客户能够预览和订购比萨饼。 API将负责提供比萨饼和订单信息，以及处理比萨饼订单。 之后，玛利亚姨妈还想添加一个移动应用程序，这个移动应用程序可以消费你的API服务。

开头稍微简单一点，第一个API端点将处理一些简单的业务逻辑并返回静态JSON对象。 你可以在图2.1中看到初始应用程序结构的概述。 该图还显示了经过API大致的HTTP请求流。

以下是我们为最初始API提供的功能列表：

- 列出所有的披萨
- 检索披萨订单
- 创建一个披萨订单
- 更新一个披萨订单
- 取消一个披萨订单

这些功能都很小的，而且也简单； 因此，你可以在单个Lambda函数中实现它们。

尽管你可能觉得应该将每个功能分成单独的功能，但现在最简单的方法是将所有功能放在同一个Lambda中，因为这些功能是紧密耦合的。 如果你也要进行库存跟踪，则可以从最开始就将其创建为单独的功能。

每个列出的功能都需要有指向函数中相应处理程序的单独路径。 你可以自己实现路由，但Claudia有一个工具可以帮助你完成该任务：Claudia API Builder。

Claudia API Builder是一个API工具，它可帮助你处理所有传入的API网关请求和响应，以及它们的配置，上下文和参数，并使你能够在Lambda函数中进行内部路由。 它具有类似Express的端点语法，所以如果你熟悉Express的话，Claudia API Builder将非常容易上手。

图2.2显示了如何使用Claudia API Builder在Lambda函数中路由和处理披萨和订单功能的详细描述。该图显示，在收到来自API Gateway的请求后，Claudia API Builder会将重定这些请求到你定义的路由及其相应的处理程序。

> NOTE
>
> 在撰写本文时，你可以用一下两种模式使用AWS API Gateway：
>
> - 使用请求和响应的模型和映射模板
> - 使用代理传递
>
> Claudia API Builder使用代理传递来捕获所有HTTP请求详细信息，并以JS开发人员友好的方式构建它们。
>
> 要了解更多有关代理传递以及模型和映射模板的信息，请阅读 http://docs.aws.amazon.com/apigateway/latest/developerguide/how-to-method-settings.html 上的官方文档。

### 2.1.1 我可以得到哪个披萨？

作为Pizza API的第一个方法，你将创建一个GET披萨服务，它可以列出所有可用的披萨。为此，你需要满足以下先决条件：

- 拥有AWS账户并正确设置AWS凭证文件
- 安装Node.js及其包管理器NPM
- 从NPM安装Claudia作为全局依赖

如果您不熟悉这些步骤或不确定是否已完成这些步骤，请跳至附录A，该附录可以指导你完成每个设置过程。

> 代码示例
>
> 从这里开始，你将看到许多代码示例。我们强烈建议您尝试所有这些示例，即使你对它们很熟悉。你可以使用您喜欢的代码编辑器，除非另有说明。

现在你已完全设置好了，你可以先为第一个无服务器应用程序创建一个空文件夹。你可以根据需要为项目文件夹命名，但在本书中，应用程序文件夹的名称为pizza-api。创建它之后，打开终端，导航到新文件夹，然后初始化Node.js应用程序。初始化应用程序后，从NPM安装claudia-api-builder模块作为程序包依赖项，如附录A中所述。

下一步是创建应用程序的入口点。在pizza-api文件夹中创建一个名为api.js的文件，并使用你喜欢的代码编辑器打开它。

> ES6语法的代码示例
>
> 本书中的所有代码示例都使用ES6 / ES2015语法。 如果你不熟悉ES6功能，例如箭头功能和/或模板字符串，请参阅由Wes Higbee著作的ES6 in Motion，本书由Manning出版，或者John Resig写的“JavaScript忍者的秘密”第二版。

想要创建API路由，您需要一个Claudia API Builder实例，因为它是一个类而不是程序函数。在api.js文件的开头，要把`claudia-api-builder`引（require）进来并实例化。

现在你可以使用Claudia API Builder的内置路由器。要实现`GET /pizzas`路由， 你需要使用Claudia API Builder实例的`get`方法。 `get`方法接收两个参数：一个路由和一个处理函数。作为route参数可传递字符串`/pizzas`，作为处理程序可传递匿名函数。

Claudia API Builder匿名处理函数与Express.js相比有一个很大的区别。在Express.js中，响应和请求会同时作为回调函数参数，但Claudia API Builder的回调函数只有请求。要发回响应，只需返回结果即可。

你的`GET /pizzas`路由应该会显示比萨饼的列表，所以现在，你应该从玛丽亚姨妈的比萨店返回一组静态的比萨饼：Capricciosa，Quattro Formaggi，Napoletana和Margherita。

最后，你需要导出你的API实例，Claudia API Builder适合该实例并将Lambda函数作为中间件。

此时，你的代码应如下所示。

```javascript
'use strict'

const Api = require('claudia-api-builder')
const api = new Api()

api.get('/pizzas', () => {
    return [
        'Capricciosa',
        'Quattro Formaggi',
        'Napoletana',
        'Margherita'
    ]
})

module.exports = api
```

这就是制作一个简单的无服务器函数所需的全部内容。 然而，在打开庆祝香槟酒瓶之前，你应该将代码部署到Lambda函数中。 为此，请跳回你的终端并释放Claudia的力量。

因为Claudia的主要目标之一是单命令部署，所以部署API只需要一个简单的`claudia create`命令即可。 此命令只需要两个选项：你希望部署API的AWS区域和应用程序的入口点。 选项作为标志传递，因此要部署API，只需使用`--region`和`--api-modules`标志执行`claudia create`命令，如清单2.2所示。 第2.2节更详细地解释了`claudia create`命令的复杂性。

> SHELL命令对于WINDOWS用户
>
> 本书中的一些命令分为多行以便于阅读和注释。 如果你是Windows用户，则可能需要将这些命令连接到一行并删除反斜杠（\）

清单2.2 使用Claudia将API部署到AWS Lambda和API Gateway

```shell
claudia create \
--region eu-central-1 \
--api-module api
```

在你所在的地区内，选择距离你最近的用户以最大限度地减少延。离玛利亚姨妈比萨店最近的地区位于德国法兰克福，它被称为`eu-central-1`。 你可以在AWS官方文档中查看所有可用区域：http://docs.aws.amazon.com/general/latest/gr/rande.html#lambda_region。

你的api.js文件是API的入口点。 Claudia会自动附加.js扩展名，所以只需输入api就可作为应用程序的入口点。

> NOTE
>
> 你的入口点的名称和位置由你自己决定；你只需要在`claudia create`命令中提供正确的入口点路径。 例如，如果将其命名为index.js并将其放在src文件夹下，则Claudia命令中的标志应为`--api-module src/index`。

大约一分钟后，Claudia将成功部署你的API。 你会看到类似于清单2.3的响应。 命令响应包含有关Lambda函数和API的有用信息，例如API的基本URL，Lambda函数的名称和区域。

> 部署问题
>
> 如果遇到部署问题（例如凭据错误），请确保按照附录A中的说明正确设置所有内容。

清单2.3 `claudia create `命令响应

```json
{
    "lambda": {
        "role": "pizza-api-executor",
        "name": "pizza-api",
        "region": "eu-central-1"
    },
    "api": {
        "id": "g8fhlgccof",
        "module": "api",
        "url": "https://whpcvzntil.execute-api.eu-central-1.amazonaws.com/latest"
    }
}
```

在部署期间，Claudia在项目的根目录中创建了一个claudia.json文件以及一些相似的信息，但没有你的根API URL。 此文件供Claudia将你的代码与某个Lambda函数和API网关实例相关联。 该文件仅适用于Claudia；不要手动改变它。

现在是时候“品尝”你的API了。 你可以直接从你喜欢的浏览器中试用它。 只需从`claudia create`响应中访问根URL，记住将路由附加到根URL。 它应该类似于https://whpcvzntil.execute-api.eu-central-1.amazonaws.com/latest/pizzas。 当你在浏览器中打开修改后的URL链接时，你应该可以看到以下内容：

```json
["Capricciosa","Quattro Formaggi","Napoletana","Margherita"]
```

> 本书示例中的URL
>
> 本书中的每个示例都不是`最新`的，它们将包含以下格式的不同版本：`chapterX_Y`，其中`X`是章节的编号，`Y`是该章节中的示例编号。 我们这样做是为了你只需复制书中的URL即可运行示例。 当你自己运行代码时，输出URL将包含`最新`版本，而不是你将在本书中看到的`chapterX_Y`。

例如，可以通过以下URL访问第一个示例：https://whpcvzntil.execute-api.eu-central1.amazonaws.com/chapter2_1/pizzas。

恭喜 - 你刚刚用Claudia构建了无服务器API！ 如果这是你第一次，你应该为自己感到自豪，这是暂停的好时机。

### 2.1.2 构建API

在急于添加更多功能之前，你应该总是尝试花几分钟时间重新思考一下你的API结构和组织。将所有路由处理器直接添加到主文件中会使其难以理解和维护，因此理想情况下应将处理程序与路由/布线分开。与一个怪物文件相比，较小的代码文件更易于理解和使用。

考虑到应用程序组织，在撰写本文时，没有任何特定的最佳实践。此外，Claudia还提供完全自由的主题。对于你的Pizza API，因为处理比萨饼和订单的部分不会变得很大，你可以将所有路径处理程序移到一个单独的文件夹中，并且仅保留api.js文件中的路径。之后，因为披萨列表不应该只有披萨名，二手应该具有更多的属性，所以你应该将其移到一个单独的文件中。你甚至可以就像我们之前提到的披萨列表一样更进一步为数据创建一个文件夹。应用这些建议后，你的代码结构应类似于图2.3。

第一个修改是将披萨列表移动到一个单独的文件中，并使用附加信息（例如比萨饼ID和成分）扩展列表。为此，在Pizza API项目的根目录创建一个文件夹，并将其命名为data。然后在新文件夹中创建一个文件，并将其命名为pizzas.json。将以下内容添加到新文件中。

清单2.4 包含披萨信息的JSON

```json
[
    {
        "id": 1,
        "name": "Capricciosa",
        "ingredients": [
            "tomato sauce", "mozzarella", "mushrooms", "ham", "olives"
        ]
    },
    {
        "id": 2,
        "name": "Quattro Formaggi",
        "ingredients": [
            "tomato sauce", "mozzarella", "parmesan cheese", "blue cheese", "goat cheese"
        ]
    },
    {
        "id": 3,
        "name": "Napoletana",
        "ingredients": [
            "tomato sauce", "anchovies", "olives", "capers"
        ]
    },
    {
        "id": 4,
        "name": "Margherita",
        "ingredients": [
            "tomato sauce", "mozzarella"
        ]
    }
]
```

下一步是将`getPizzas`处理程序移动到单独的文件中。 在项目根目录中创建一个名为handlers的文件夹，并在其中创建一个get-pizzas.js文件。

在你的新get-pizzas.js文件中将是`getPizzas`处理程序，它返回清单2.4中的比萨列表。 首先，您需要从您创建的JSON文件中导入比萨列表。 其次，您需要创建一个`getPizzas`处理函数并将其导出，以便您可以从您的条目文件中获取它。 然后，如果将比萨饼ID作为参数传递给您的`getPizzas`处理程序，则不要只返回比萨饼列表，更进一步并返回一个比萨饼。 要返回一个披萨，您可以使用`Array.find`方法，该方法通过披萨列表中的披萨ID搜索披萨。 如果找到披萨，请返回
它作为处理结果。 如果没有任何带有该ID的比萨饼，请让您的应用程序抛出错误。

新披萨处理程序的更新代码应与下一个列表类似。

清单2.5 在单独的文件中使用比萨ID过滤器的`getPizzas`处理程序

```javascript
const pizzas = require('../data/pizzas.json')

function getPizzas(pizzaId) {
    if (!pizzaId)
        return pizzas
    
    const pizza = pizzas.find((pizza) => {
        return pizza.id == pizzaId
    })
    
    if (pizza)
        return pizza
    throw new Error('The pizza you requested was not found')
}

module.exports = getPizzas
```

